name: FunGen macOS Intel – self-contained .app (manual conda setup)

on:
  workflow_dispatch:
  push:
    tags: [ 'v*' ]

jobs:
  build-macos-intel:
    runs-on: macos-15-intel

    env:
      APP_NAME: FunGen
      ENV_NAME: FunGen
      MINICONDA_DIR: ${{ github.workspace }}/miniconda3

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show runner info
        run: |
          echo "uname -a: $(uname -a)"
          echo "arch: $(uname -m)"
          sysctl -n machdep.cpu.brand_string || true
          sw_vers

      - name: Install base tools (git, ffmpeg, 7zip)
        run: |
          brew update
          brew install git ffmpeg p7zip

      # 1) Miniconda x86_64
      - name: Preinstall Miniconda (x86_64) into workspace
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ github.workspace }}"
          URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh"
          curl -fsSL "$URL" -o miniconda.sh
          bash miniconda.sh -b -p "${{ env.MINICONDA_DIR }}"
          rm -f miniconda.sh
          echo "${{ env.MINICONDA_DIR }}/bin" >> $GITHUB_PATH
          "${{ env.MINICONDA_DIR }}/bin/python" -V

      # 2) Créer l'env conda FunGen (Python 3.11)
      - name: Create conda env (Python 3.11)
        shell: bash
        run: |
          set -euo pipefail
          "${{ env.MINICONDA_DIR }}/bin/conda" create -y -p "${{ env.MINICONDA_DIR }}/envs/${{ env.ENV_NAME }}" python=3.11
          "${{ env.MINICONDA_DIR }}/bin/conda" run -p "${{ env.MINICONDA_DIR }}/envs/${{ env.ENV_NAME }}" python -V

      # 3) Installer les dépendances du repo (core.requirements.txt -> requirements.txt -> pyproject.toml)
      - name: Install Python dependencies into env
        shell: bash
        run: |
          set -euo pipefail
          ENV_PATH="${{ env.MINICONDA_DIR }}/envs/${{ env.ENV_NAME }}"
          PIP="${ENV_PATH}/bin/pip"
          PY="${ENV_PATH}/bin/python"

          $PIP install --upgrade pip wheel setuptools

          if [ -f "core.requirements.txt" ]; then
            echo "Installing from core.requirements.txt"
            $PIP install -r core.requirements.txt
          elif [ -f "requirements.txt" ]; then
            echo "Installing from requirements.txt"
            $PIP install -r requirements.txt
          elif [ -f "pyproject.toml" ]; then
            echo "Installing from pyproject.toml (PEP 517)"
            # Si build-backend, installe en mode dev/standard
            $PIP install .
          else
            echo "⚠️   Aucun fichier de requirements trouvé. Tentative d’install minimale..."
            # Option de secours : rien à faire
          fi

          # logs rapides
          $PY -c "import sys; print(sys.version)"
          $PY -c "import pkgutil; print('pkgs:', len(list(pkgutil.iter_modules())))"

      # 4) Déterminer le point d’entrée (main.py ou équivalent)
      - name: Locate project entrypoint
        id: locate
        shell: bash
        run: |
          set -euo pipefail
          # Cherche un main.py dans le repo
          PROJ_DIR="${{ github.workspace }}"
          if [ -f "${PROJ_DIR}/main.py" ]; then
            ENTRY="${PROJ_DIR}/main.py"
          else
            ENTRY="$(find "${PROJ_DIR}" -maxdepth 3 -type f -name main.py -print -quit || true)"
          fi
          if [ -z "${ENTRY:-}" ] || [ ! -f "$ENTRY" ]; then
            echo "❌ main.py introuvable dans le repo. Adapte ce step si l'entrée est différente." >&2
            exit 1
          fi
          echo "ENTRY=$ENTRY" >> $GITHUB_OUTPUT
          echo "PROJ=$(dirname "$ENTRY")" >> $GITHUB_OUTPUT
          echo "Found entry: $ENTRY"

      # 5) Créer le bundle .app
      - name: Create .app bundle layout
        shell: bash
        run: |
          set -euo pipefail
          APP="${{ github.workspace }}/${{ env.APP_NAME }}.app"
          mkdir -p "$APP/Contents/MacOS" "$APP/Contents/Resources" "$APP/Contents/Frameworks"
          cat > "$APP/Contents/Info.plist" <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key> <string>FunGen</string>
            <key>CFBundleDisplayName</key> <string>FunGen</string>
            <key>CFBundleIdentifier</key> <string>com.yourorg.fungen</string>
            <key>CFBundleExecutable</key> <string>FunGen</string>
            <key>CFBundlePackageType</key> <string>APPL</string>
            <key>CFBundleShortVersionString</key> <string>1.0</string>
            <key>LSMinimumSystemVersion</key> <string>11.0</string>
            <key>NSHighResolutionCapable</key> <true/>
          </dict>
          </plist>
          PLIST
          echo "APP_PATH=$APP" >> "$GITHUB_ENV"

      # 6) Embarquer env + projet + ffmpeg
      - name: Embed conda env, project and ffmpeg into app
        shell: bash
        run: |
          set -euo pipefail
          APP="$APP_PATH"
          ENV_PATH="${{ env.MINICONDA_DIR }}/envs/${{ env.ENV_NAME }}"
          PROJ="${{ steps.locate.outputs.PROJ }}"

          # Env conda complet
          rsync -a "$ENV_PATH/" "$APP/Contents/Resources/conda_env/"

          # Code projet (repo courant)
          rsync -a --exclude '.git' "$PROJ/" "$APP/Contents/Resources/FunGen/"

          # ffmpeg/ffprobe → Resources/bin
          mkdir -p "$APP/Contents/Resources/bin"
          cp "$(brew --prefix)/bin/ffmpeg"  "$APP/Contents/Resources/bin/" || true
          cp "$(brew --prefix)/bin/ffprobe" "$APP/Contents/Resources/bin/" || true
          chmod +x "$APP/Contents/Resources/bin/"* || true

          # Launcher
          cat > "$APP/Contents/MacOS/FunGen" <<'LAUNCH'
          #!/bin/bash
          set -e
          APPDIR="$(cd "$(dirname "$0")"/.. && pwd)"
          CONDA="$APPDIR/Resources/conda_env"
          PROJ="$APPDIR/Resources/FunGen"
          export PATH="$CONDA/bin:$APPDIR/Resources/bin:$PATH"
          export PYTHONHOME="$CONDA"
          export PYTHONNOUSERSITE=1
          export DYLD_FALLBACK_LIBRARY_PATH="$CONDA/lib${DYLD_FALLBACK_LIBRARY_PATH:+:$DYLD_FALLBACK_LIBRARY_PATH}"
          if [ -d "$CONDA/lib/python3.11/site-packages/numpy/.dylibs" ]; then
            export DYLD_FALLBACK_LIBRARY_PATH="$CONDA/lib/python3.11/site-packages/numpy/.dylibs:$DYLD_FALLBACK_LIBRARY_PATH"
          fi
          exec "$CONDA/bin/python" "$PROJ/main.py" "$@"
          LAUNCH
          chmod +x "$APP/Contents/MacOS/FunGen"

      # 7) Smoke test
      - name: Smoke test (CLI)
        shell: bash
        run: |
          set -euo pipefail
          "$APP_PATH/Contents/MacOS/FunGen" --help || true
          "$APP_PATH/Contents/MacOS/FunGen" -c "import sys,subprocess;print(sys.version);subprocess.run(['ffmpeg','-version'])" || true

      # 8) Zip + artifact
      - name: Zip the app
        run: |
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "FunGen-macOS-Intel.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FunGen-macOS-Intel
          path: FunGen-macOS-Intel.zip
          retention-days: 14
